name: Docker Build Test

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      run: |
        docker build \
          --build-arg CACHEBUST="$(date +%s)" \
          -t opencode-docker:test \
          -f Dockerfile \
          .

    - name: Test image basic functionality
      run: |
        # Test that image was built
        docker images | grep opencode-docker

        # Test that entrypoint exists and is executable
        docker run --rm --entrypoint ls opencode-docker:test -la /usr/local/bin/entrypoint.sh

        # Test that OpenCode is installed (run as opencode user via entrypoint)
        docker run --rm opencode-docker:test which opencode

        # Test Python tools
        docker run --rm opencode-docker:test python3 --version
        docker run --rm opencode-docker:test uv --version

        # Test Node.js tools
        docker run --rm opencode-docker:test node --version
        docker run --rm opencode-docker:test npm --version

        # Test Bun
        docker run --rm opencode-docker:test bun --version

        # Test Git tools
        docker run --rm opencode-docker:test git --version
        docker run --rm opencode-docker:test gh --version
        docker run --rm opencode-docker:test glab --version

    - name: Test SSH and security
      run: |
        # Verify SSH config exists
        docker run --rm opencode-docker:test cat /home/opencode/.ssh/config

        # Verify GitHub host keys are configured
        docker run --rm opencode-docker:test sh -c "cat /home/opencode/.ssh/known_hosts | grep -q github.com"

        # Verify running as non-root user (after entrypoint switches)
        docker run --rm opencode-docker:test whoami

    - name: Test script syntax
      run: |
        # Check bash script syntax
        bash -n opencode-docker
        bash -n entrypoint.sh
